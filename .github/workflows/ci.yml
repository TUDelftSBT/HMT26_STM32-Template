name: CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t stm32-dev -f .devcontainer/Dockerfile .

      - name: Build firmware
        run: |
          docker run --rm -t \
            --user "$(id -u):$(id -g)" \
            -v "${{ github.workspace }}:/work" -w /work \
            stm32-dev bash -lc "
              set -e
              rm -rf build
              cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug
              cmake --build build -j
              test -f build/HMT26_FIRMWARE.elf
            "

      - name: Run unit tests
        run: |
          docker run --rm -t \
            --user "$(id -u):$(id -g)" \
            -v "${{ github.workspace }}:/work" -w /work \
            stm32-dev bash -lc "
              set -e
              rm -rf build-host
              cmake -S tests -B build-host -DCMAKE_BUILD_TYPE=Debug
              cmake --build build-host -j
              ctest --test-dir build-host --output-on-failure
            "
