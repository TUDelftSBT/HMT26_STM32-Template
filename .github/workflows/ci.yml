name: CI

on:
  push:
  pull_request:

jobs:
  build-test-analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # static analysis
      - name: Install cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Run cppcheck (Project + Modules)
        run: |
          cppcheck --version
          cppcheck \
            --enable=warning,style,performance,portability \
            --inline-suppr \
            --error-exitcode=1 \
            --std=c11 \
            -I Project/Inc \
            -I Modules \
            Project Modules

      # Build + unit tests in Docker
      - name: Build Docker image
        run: |
          docker build -t stm32-dev -f .devcontainer/Dockerfile .

      - name: Build firmware (ARM)
        run: |
          docker run --rm -t \
            -v "$PWD:/work" -w /work \
            stm32-dev bash -lc '
              git config --global --add safe.directory /work || true
              cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug
              cmake --build build -j
              test -f build/HMT26_FIRMWARE.elf
            '

      - name: Build & run unit tests (host)
        run: |
          docker run --rm -t \
            -v "$PWD:/work" -w /work \
            stm32-dev bash -lc '
              git config --global --add safe.directory /work || true
              cmake -S tests -B build-host -DCMAKE_BUILD_TYPE=Debug
              cmake --build build-host -j
              ctest --test-dir build-host --output-on-failure
            '
